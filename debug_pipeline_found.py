#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
üîç Debug Pipeline Encontrada
Script para investigar a Pipeline #2025-09-09-009 encontrada no banco
"""

import sys
import os
import json
from datetime import datetime

# Adicionar o diret√≥rio backend ao path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'backend'))

def debug_pipeline_found():
    """Debugar a pipeline espec√≠fica encontrada"""
    print("üîç [DEBUG] Investigando Pipeline #2025-09-09-009...")
    print("=" * 60)
    
    try:
        # Importar app e criar contexto
        from app import app, db, Pipeline, PipelineLog
        
        with app.app_context():
            if Pipeline:
                # Buscar pipeline espec√≠fica por display_name
                pipeline = Pipeline.query.filter(
                    Pipeline.display_name.like('%2025-09-09-009%')
                ).first()
                
                if pipeline:
                    print(f"üìã PIPELINE ENCONTRADA NO BANCO:")
                    print(f"   ID (UUID): {pipeline.pipeline_id}")
                    print(f"   Display Name: {pipeline.display_name}")
                    print(f"   T√≠tulo: {pipeline.title}")
                    print(f"   Status: {pipeline.status}")
                    print(f"   Progresso: {pipeline.progress}%")
                    print(f"   Etapa atual: {pipeline.current_step}")
                    print(f"   Canal URL: {pipeline.channel_url}")
                    print(f"   Estilo de v√≠deo: {pipeline.video_style}")
                    print(f"   Dura√ß√£o alvo: {pipeline.target_duration}s")
                    print()
                    
                    # Verificar configura√ß√£o
                    if pipeline.config_json:
                        try:
                            config = json.loads(pipeline.config_json)
                            print(f"üìÑ CONFIGURA√á√ÉO:")
                            print(json.dumps(config, indent=2, ensure_ascii=False))
                            print()
                        except Exception as e:
                            print(f"   ‚ùå Erro ao decodificar config_json: {e}")
                    
                    # Verificar configura√ß√£o do agente
                    if pipeline.agent_config:
                        try:
                            agent_config = json.loads(pipeline.agent_config)
                            print(f"ü§ñ CONFIGURA√á√ÉO DO AGENTE:")
                            print(json.dumps(agent_config, indent=2, ensure_ascii=False))
                            print()
                        except Exception as e:
                            print(f"   ‚ùå Erro ao decodificar agent_config: {e}")
                    
                    # Verificar resultados de cada etapa
                    print(f"üìä RESULTADOS DAS ETAPAS:")
                    if pipeline.extraction_results:
                        print(f"   ‚úÖ Extraction: {len(pipeline.extraction_results)} chars")
                    else:
                        print(f"   ‚ùå Extraction: N√£o executado")
                    
                    if pipeline.titles_results:
                        print(f"   ‚úÖ Titles: {len(pipeline.titles_results)} chars")
                    else:
                        print(f"   ‚ùå Titles: N√£o executado")
                    
                    if pipeline.premises_results:
                        print(f"   ‚úÖ Premises: {len(pipeline.premises_results)} chars")
                    else:
                        print(f"   ‚ùå Premises: N√£o executado")
                    
                    if hasattr(pipeline, 'scripts_results') and pipeline.scripts_results:
                        print(f"   ‚úÖ Scripts: {len(pipeline.scripts_results)} chars")
                    else:
                        print(f"   ‚ùå Scripts: N√£o executado")
                    
                    if hasattr(pipeline, 'tts_results') and pipeline.tts_results:
                        print(f"   ‚úÖ TTS: {len(pipeline.tts_results)} chars")
                    else:
                        print(f"   ‚ùå TTS: N√£o executado")
                    
                    if hasattr(pipeline, 'images_results') and pipeline.images_results:
                        print(f"   ‚úÖ Images: {len(pipeline.images_results)} chars")
                    else:
                        print(f"   ‚ùå Images: N√£o executado")
                    
                    if hasattr(pipeline, 'video_results') and pipeline.video_results:
                        print(f"   ‚úÖ Video: {len(pipeline.video_results)} chars")
                    else:
                        print(f"   ‚ùå Video: N√£o executado")
                    
                    print()
                    
                    # Buscar logs da pipeline
                    if PipelineLog:
                        logs = PipelineLog.query.filter_by(
                            pipeline_id=pipeline.pipeline_id
                        ).order_by(PipelineLog.timestamp.desc()).limit(10).all()
                        
                        if logs:
                            print(f"üìù √öLTIMOS 10 LOGS:")
                            for log in logs:
                                print(f"   [{log.timestamp}] {log.level.upper()}: {log.message}")
                                if log.step:
                                    print(f"      Etapa: {log.step}")
                                if log.data:
                                    try:
                                        data = json.loads(log.data)
                                        print(f"      Dados: {json.dumps(data, ensure_ascii=False)}")
                                    except:
                                        print(f"      Dados: {log.data}")
                                print()
                        else:
                            print(f"üìù Nenhum log encontrado para esta pipeline")
                    
                    print()
                    print(f"üîç AN√ÅLISE:")
                    
                    # Verificar por que est√° no polling
                    if pipeline.status in ['queued', 'processing']:
                        print(f"   ‚ö†Ô∏è  Pipeline est√° com status '{pipeline.status}' - por isso aparece no polling")
                        print(f"   üìä Progresso atual: {pipeline.progress}%")
                        
                        if pipeline.status == 'queued':
                            print(f"   üí° SOLU√á√ÉO: Pipeline est√° na fila mas n√£o est√° sendo processada")
                            print(f"      - Verifique se h√° threads de processamento ativas")
                            print(f"      - Considere cancelar ou reiniciar a pipeline")
                        
                        elif pipeline.status == 'processing':
                            print(f"   üí° SOLU√á√ÉO: Pipeline est√° sendo processada")
                            print(f"      - Verifique logs do backend para ver o progresso")
                            print(f"      - Se travou, considere reiniciar")
                    
                    elif pipeline.status in ['completed', 'failed', 'cancelled']:
                        print(f"   ‚úÖ Pipeline j√° foi finalizada com status '{pipeline.status}'")
                        print(f"   üí° SOLU√á√ÉO: Remover do polling ou limpar do banco")
                    
                    else:
                        print(f"   ‚ùì Status desconhecido: '{pipeline.status}'")
                    
                    return pipeline
                
                else:
                    print("‚ùå Pipeline #2025-09-09-009 n√£o encontrada no banco")
                    return None
            
            else:
                print("‚ùå Modelo Pipeline n√£o dispon√≠vel")
                return None
    
    except Exception as e:
        print(f"‚ùå Erro ao verificar pipeline: {e}")
        import traceback
        traceback.print_exc()
        return None

def check_memory_state():
    """Verificar estado em mem√≥ria"""
    print("\nüß† Verificando estado em mem√≥ria...")
    
    try:
        from routes.pipeline_complete import active_pipelines, pipeline_logs
        
        print(f"üìä Pipelines ativos em mem√≥ria: {len(active_pipelines)}")
        
        # Procurar pela pipeline espec√≠fica
        found_in_memory = False
        for pipeline_id, pipeline_data in active_pipelines.items():
            if '2025-09-09-009' in pipeline_id or '2025-09-09-009' in str(pipeline_data):
                print(f"   ‚ö†Ô∏è  PIPELINE ENCONTRADA EM MEM√ìRIA: {pipeline_id}")
                print(f"   üìÑ Dados: {json.dumps(pipeline_data, indent=2, default=str, ensure_ascii=False)}")
                found_in_memory = True
        
        if not found_in_memory:
            print(f"   ‚úÖ Pipeline n√£o encontrada em mem√≥ria")
            print(f"   üí° Isso explica por que o polling busca do banco")
    
    except Exception as e:
        print(f"‚ùå Erro ao verificar mem√≥ria: {e}")

def suggest_solutions(pipeline):
    """Sugerir solu√ß√µes baseadas no estado da pipeline"""
    print("\nüí° SOLU√á√ïES RECOMENDADAS:")
    print("=" * 40)
    
    if not pipeline:
        print("1. Pipeline n√£o encontrada - verificar se foi removida")
        return
    
    if pipeline.status == 'queued':
        print("1. üîÑ REINICIAR PROCESSAMENTO:")
        print("   - Parar o backend (Ctrl+C)")
        print("   - Reiniciar o backend")
        print("   - A pipeline ser√° retomada automaticamente")
        print()
        print("2. ‚ùå CANCELAR PIPELINE:")
        print("   - Usar endpoint DELETE /api/pipeline/{pipeline_id}")
        print("   - Ou atualizar status no banco para 'cancelled'")
        print()
        print("3. üßπ LIMPAR BANCO:")
        print("   - Remover pipelines antigas com status 'queued'")
        print("   - Implementar limpeza autom√°tica")
    
    elif pipeline.status == 'processing':
        print("1. ‚è±Ô∏è  AGUARDAR CONCLUS√ÉO:")
        print("   - Pipeline pode estar processando normalmente")
        print("   - Verificar logs do backend para progresso")
        print()
        print("2. üîÑ REINICIAR SE TRAVOU:")
        print("   - Se n√£o h√° progresso h√° muito tempo")
        print("   - Reiniciar backend para retomar")
    
    elif pipeline.status in ['completed', 'failed', 'cancelled']:
        print("1. üßπ REMOVER DO POLLING:")
        print("   - Pipeline j√° foi finalizada")
        print("   - N√£o deveria aparecer no polling")
        print("   - Verificar l√≥gica de filtragem no frontend")
        print()
        print("2. üóëÔ∏è  LIMPAR BANCO:")
        print("   - Remover pipelines antigas finalizadas")
        print("   - Manter apenas as ativas")

if __name__ == "__main__":
    print(f"üöÄ Iniciando debug detalhado em {datetime.now()}")
    pipeline = debug_pipeline_found()
    check_memory_state()
    suggest_solutions(pipeline)
    print("\n‚úÖ Debug detalhado conclu√≠do")